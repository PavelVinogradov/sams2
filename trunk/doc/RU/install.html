<HTML>
<HEAD>
<TITLE>Проект SAMS. Документация.</TITLE>
<META  content="text/html; charset=koi8-r" http-equiv="Content-Type">
</HEAD>
<BODY>
<H2>Инсталляция SAMS</H2>
<P>1.  Разархивируйте этот архив:
<P>    tar zxf sams-xxxxxx.tar.gz
<P>    будет создан каталог, в котором будет размещено содержимое архива.
<P>2.  Переместитесь в него
<BR>    сd sams-xxxxxx
<P>3.  Собрать и установить SAMS можно используя скрипт установки setup.sh 
или традиционным способом: configure, make, make install
<P><B>Инсталляции SAMS, используя  скрипт установки setup.sh</B>
<P>
Скрипт sams.sh требует наличия в системе утилиты dialog - средства создания 
интерфейса пользователя в shell.
<P>Скрипт sams.sh позволяет сконфигурировать и установить SAMS, а также 
создать пользователя и базы SAMS в MySQL.
<P>Запустите скрипт sams.sh
<BR>- Выберите пункт "Run the new installation of the SAMS" 
<BR>- Последовательно выполните пункты открывшегося меню:
<BR>configure - установка опций и выполнение configure
<BR>make - компиляция sams
<BR>make install - установка sams
<BR>mysql - создание пользователя и баз SAMS в MySQL
<BR>
<BR>

<P><B>Инсталляции SAMS, используя  configure, make, make install</B>

<P>    Для настройки конфигурации воспользуйтесь командой
<BR>    % ./confugure
<P>    По путь по-умолчанию SASM находится  /usr/local.
<BR>Если вы захотите изменить путь:
<BR> к расположению программ и путь к расположению библиотек и файлов
заголовков MySQL
<BR> к каталогу расположения root директории http сервера (если путь к нему
отличается от /var/www/html или /var/www/htdocs
<BR> к каталогу расположения php
<BR> для получения списка опций настройки наберите:
<BR>    % ./confugure --help
<P>4.  По завершении работы команды configure откомпилируйте дистрибутив
и инсталлируйте его.
<P>    Linux
<BR>   % make
<BR>    % make install
<P>    FreeBSD
<BR >   % gmake
<BR>    % gmake install

<P>5. <B>Создание пользователя MySQL</B>
<BR><A HREF="mysql.html">Создайте</A> в MySQL пользователя, от имени которого будет работать
SAMS. По умолчанию это пользователь sams. Измените пользователя
и пароль доступа к базе в файле  /etc/sams.conf
<P>    например:
<BR>       MYSQLHOSTNAME=localhost
<BR>      MYSQLUSER=sams
<BR>      MYSQLPASSWORD=sams_password
<BR>    Измените в файле конфигурации путь к файлу access.log squid.
<BR>    например:
<BR>       SQUIDLOGDIR=/var/log/squid
<BR>      SQUIDCACHEFILE=access.log

<P>6.<B>Расположение файлов SAMS</B>
<BR>По окончании инсталляции файлы SAMS будут проинсталлированы:
<BR> /etc:
<BR> sams.conf - файл конфигурации SAMS
<P> /usr/local/sams:
<BR>файлы:
<BR>sams - анализатор логов squid
<BR>samsf - демон, создающий fifo файл, в который squid записывает логи.
<BR>samsdaemon - демон, отвечающий за переконфигурацию squid и автоматический запуск sams и samsf
<P> /usr/local/share/sams:
<BR>файлы WEB-интерфейса sams

<P>7.<B>Создание баз SAMS в MySQL</B>
<BR>Перейдите в каталог /usr/src/sams-XXXXXX/mysql

<P>8.  <A HREF="mysql.html">Запустите скрипты</A> create_sams_db и create_squid_db. В результате их
исполнения будут созданы базы MySQL, необходимые для работы SAMS.

<P>9.<B>Создание каталога SAMS http сервера</B>
<BR>В результате инсталляции должен быть создан симлинк из root каталога http
сервера на каталог web-интерфейса SAMS. Если он не создан, <A HREF="apache.html">
создайте симлинк</A> из каталога вашего web-сервера на каталог /usr/local/share/sams
<BR>    ln -s /usr/local/share/sams /our/path/www/htdocd/sams.

<P>10. Измените владельца каталога /usr/local/share/sams на пользователя, от имени
которого работает ваш web сервер.
<P>    например:
<BR>    chown -R apache:apache /usr/local/share/sams

<P>11. Смените права доступа на католог /usr/local/share/sams/data на 777.

<P>12. <B> Настройка NTLM авторизации</B>
<BR>Если планируется использовать NTLM авторизацию в домене Windows NT 4.0, <A HREF="samba.html">настройте winbind </A>, а также squid на работу с winbind-авторизацией.
<BR>Если планируется использовать NTLM авторизацию в домене Windows 2000/2003, <A HREF="samba3.html">настройте winbind </A>, а также squid на работу с winbind-авторизацией.

<P>13. Если планируется использовать <A HREF="adldap.html">авторизацию в Active Directory</A>, 
настройте squid на работу с авторизацией в AD.


<P>14. <B>Настройка чтения логов SQUID</B>
<BR>Чтение логов SQUID и занесение данных в базу данных SAMS может производиться
двумя способами:
<P> 14.1 - /usr/local/bin/sams - запускается периодически и считывает информацию из файла access.log.
 Необходимо осуществлять запуск этой программы с периодичностью 1 раз в минуту.
<P> Запуск программы sams может быть произведено samdaemon автоматически
<A HREF="sams_conf.html">(см. настройку) </A> или из cron
<BR>   Для запуска ис cron  создайте демону cron задание:
<BR>    */1 * * * * /usr/local/bin/sams
<P> 14.2 - /usr/local/bin/samsf - после запуска остается в памяти демоном, устанавливает fifo файл access.log
и squid заносит логи напрямую в sams. samsf может быть произведен samdaemon автоматически
<A HREF="sams_conf.html">(см. настройку) </A> или из скрипта
при загрузке ОС.
<P> Какой способ чтения логов выбрать? Оба способа имеют свои достоинства и недостатки:
<P> sams:
<BR> + При крахе базы данных они могут быть восстановлены из файлов логов squid (access.log)
<BR> - Пересчет трафика и отключение пользователей происходит с запозданием. 

<P> samsf:
<BR> + Пересчет трафика и отключение пользователей происходит сразу, как данные об этом поступят от SQUID
<BR> -  Так как SQUID пишет логи непосредственно в samsf, при крахе базы данных данные о трафике 
пользователей могут быть потеряны. Не забывайте делать backup базам sams 


<P>15. <B>Очистка счетчиков трафика пользователей</B>
<BR>SAMS ведет учет объема информации, полученной пользователями. По превышении
объема информации, пользователь отключается от доступа к прокси-серверу.

<P>Необходимо настроить очистку счетчика пользователя 1 числа каждого месяца. Это может быть произведено
samdaemon автоматически <A HREF="sams_conf.html">(см. настройку) </A>
<P>    или создайте демону cron задание:
<BR>    0 0 1 * * /usr/local/sams/bin/sams -c

<P>16. <B>Настройка запуска samsdaemon </B>
<BR>Настройте систему на автоматический запуск демона
<BR>    /usr/local/bin/samsdaemon, необходимого для работы SASM.
<P>    Для RedHat-based дистрибутивов:
<BR>       Установите автоматический запуск /etc/init.d/samsd
<P>    Для Slackware:
<BR>       В файл /etc/rc.d/rc.local добавьте строку:
<BR>       /usr/local/bin/samsdaemon

<P>17. <B>Дополнительно:</B>
<P>Незабудьте раскомментировать в php.ini вызов библиотеки mysql.so
<P> Создайте каталог /tmp/sams. В него SAMS будет складывать временные файлы и
смените права доступа на католог /tmp/sams на 777.
<BR>mkdir /tmp/sams
<BR>chmod 777 /tmp/sams
</BODY></HTML>
