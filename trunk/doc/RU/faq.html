<HTML>
<BODY>
<H2 align="center">FAQ</H2>

<H3 align="center">О SAMS</H3>

<P>
<B>Что такое SAMS?</B> 
<BR>SAMS не является биллинговой системой, это  система управления доступом 
пользователей к прокси серверу SQUID.


<P>
<B>Какой трафик считает SAMS?</B> 
<BR>
SAMS считает трафик по данным, заносимым в файл access.log прокси сервером SQUID. 
SQUID является прокси сервером для http, https, ftp протоколов.

<P>
<B>Насколько трудно установить и настроить SAMS?</B> 
<BR>На самом деле не так уж и сложно. В современных дистрибутивах есть в наличие все 
необходимые пакеты и собирается он без проблем. В документации подробно описаны все 
шаги установки и настройки. 
<BR>С NCSA авторизацией или доступом по ip адресам проблем недолжно быть вообще.
<BR>Проблемы возникают при использовании NTLM авторизации. Но это не проблема SAMS, это 
проблема используемой для авторизации SAMBA. В документации SAMS настройка NTLM 
авторизации описано подробно, кроме того это широко освещено в интернете (многие 
наступают на эти грабли :)

<H3 align="center">Сборка и установка SAMS</H3>

<B>Какие пакеты должны быть установлены для сборки и функционирования SAMS?</B> 
<BR>
Все зависит от вида авторизации пользователей в SQUID. 
<BR>для сборки и функционирования SAMS должны быть поставлены:
<LI>MySQL server
<LI>MySQL client
<LI>файлы заголовков библиотек MySQL (mysql-devel-*.rpm)
<LI>Apache http server
<LI>Модули php для Apache (mod_php.rpm)
<LI>php
<LI>php-mysql
<LI>библиотека PCRE (libpcre-*.rpm)
<LI>файлы заголовков библиотеки PCRE (libpcre-devel-*.rpm)
<LI>SQUID
<BR>если вы хотите использовать NTLM авторизацию в домене Windows NT
<LI>SAMBA 2.x server 
<LI>SAMBA 2.x client 
<BR>если вы хотите использовать NTLM авторизацию в домене Windows 2000/2003
<LI>SAMBA 3.x server 
<LI>SAMBA 3.x client 
<BR>если вы хотите использовать авторизацию в Active Directory
<LI>php-ldap  
<LI>libgd - библиотека поддержки графики
<LI>php-gd - модуль поддержки libgd в php (используется для рисования графиков)

<P>
<B>Имеет ли значение порядок установки программных пакетов (Samba,Squid, Apache+PHP, SAMS)?</B> 
<BR>
Порядок установки Samba,Squid, Apache+PHP значения не имеет, главное чтобы перед установкой SAMS 
установить все пакеты с заголовками mysql-devel, libpcre-devel. 

<P>
<B>Как мне создать базу и таблицы MySQL?</B>
<BR>Описание создание базы и пользователя SAMS в MySQL описано в документации 
<A HREF="mysql_install.html">Установка и создание базы SAMS в MySQL</A>

<P>
<B>Почему для хранения данных используется SQL?</B>
<BR>Это позволяет делать более подробные и гибкие отчеты о полученном пользователем трафике.

<P>
<B>У меня чего-то не компилируется/не настроено/не работает, помогите!</B>
<BR>SAMS сопровождается подробной документацией, по-этому консультацией по e-mail, icq и т.п. я не провожу. 
У вас есть две возможности. Можно обратиться к автору программы за платной поддержкой по инсталляции и настройке. 
Или можно обратиться за поддержкой в форум, где надо указать: 
<A href="http://www.linux.perm.ru/forum/viewtopic.php?t=359"> читайте здесь</A>

<P>
<B>Программа sams/samsf/samsdaemon падает, что делать?</B>
<BR>См. предыдущий вопрос. Все программы при запуске в консоли с ключем -d выводят подробный лог своей работы.

<P>
<B>Ага, автор просто не хочет отвечать на вопросы, так как хочет заработать на этом деньги!</B>
<BR>Автор затратил много времени на написание этой программы и документации к ней. Еще и тратить 
время на решение возникающих у вас проблем совсем нехочется. Как показывает длительный опыт ответов на вопросы, 
они возникают от нежелания читать документацию, форум, поискать ответ в интернете или просто разобраться как 
это все работает. Гораздо проще написать письмо автору, он ответит. Не так ли?
<BR>А деньги... SAMS ведь вы ставите для исполнения ваших служебных обязанностей, а вы ведь не работаете бесплатно?

<P>
<B>Как скомпилить Sams в FreeBSD, OpenBSD?</B> 
<BR>Поставьте из портов gmake
<BR># ./configure
<BR>затем
<BR># gmake

<P>
<B>На каком компиляторе собирался Sams на Sun Solaris?</B> 
<BR>На Sun Solaris 8,9 x86 собирался при помощи gcc-small-3.3.2-sol8-intel-local 


<H3 align="center">Ошибки при сборке SAMS</H3>

<P>
<B>При попытке сделать configure начинает ругаться:
<BR>checking for mysql.h in... configure: error: Cannot find MySQL's mysql.h in... MySQL в системе поставлен и функционирует.</B> 
<BR>Отсутствуют файлы заголовков MySQL. Необходимо поставить файл примерно с таким названием: MySQL-dev.rpm

<P>
<B>При попытке сделать configure начинает ругаться:
<BR>checking for <pcre.h> in /usr/include/pcre... configure: error: Cannot find PCRE's <pcre.h> in /usr/include/pcre
<BR>redirect.c:695: dereferencing pointer to incomplete type
<BR>redirect.c:695: invalid use of undefined type `struct samsurls'</B>
<BR>Отсутствуют файлы заголовков PCRE. Необходимо поставить файл примерно с таким названием: pcre-dev.rpm
<Если pcre.h в системе установлен, то необходимо подправить путь к нему в файле sams/pcre.h (redirect.c)

<P>
<B>При попытке запустить samsdaemon, sams или samsf выдает что-то вроде:
<BR># sams
<BR>/libexec/ld-elf.so.1: Shared object "libmysqlclient.so.14" not found, required by "sams"</B>
<BR>Эта ошибка означает, что ненайдена библиотека libmysqlclient.so.14. 
<BR>Поищите на диске библиотеку libmysqlclient.so.14.x.x, скорее всего она лежит в /usr/lib и сделайте на нее симлинк
ln -s libmysqlclient.so.14.x.x libmysqlclient.so.14 

<P>
<B> При запуске make выдает:
<BR>"Makefile", line 311: Need an operator
<BR>make: fatal errors encountered -- cannot continue
<BR> ОС FreeBSD</B>
<BR># ./configure
<BR>затем
<BR># gmake

<H3 align="center">Проблемы с запуском WEb интерфейса SAMS</H3>

<P>
<TABLE WIDTH="95%">
<TR>
<TD>
<B>У меня FreeBSD и при попытке ввода пароля пользователя Admin я получаю ответ: Authentication ERROR</B>
<BR>Во FreeBSD по-умолчанию используется blowfish шифрование. Пароль пользователя Admin закодирован 
традиционным для Linux способом :)
<BR>Запустите скрипт setpassword.php и он перекодирует пароль пользователя Admin:


<P>
<TABLE WIDTH="95%">
<TR>
<TD>
<B>Если при обращении к веб интерфейсу вы наблюдаете такую картинку, то:</B>
<BR>Необходимо включить в файле конфигурации web сервера поддержку php.
<BR>Раскомментируйте или добавьте следующие строки:
<BR>LoadModule php4_module libexec/libphp4.so
<BR>AddModule mod_php4.c
<BR>AddType application/x-httpd-php .php .phtml 
<TD>
<IMG SRC="../img/nophp.jpg">

<TR>
<TD>
<B>Если при обращении к веб интерфейсу вы можете видеть только чистый экран, или такую картинку, то:</B>
<BR>Непроизведено подключение к MySQL.
<BR>1.Проверьте, запущена ли MySQL
<BR>2.Проверьте, раскомментирован ли вызов модуля MySQL в конфигурационных файлах php 
(/etc/php.in, /etc/httpd/conf/php.ini и т.п., зависит от дистрибутива).
<BR>3.Проверьте правильность файла sams.conf
<BR>SQUID_DB=squidlog
<BR>SAMS_DB=squidctrl
<BR>MYSQLHOSTNAME=localhost
<BR>MYSQLUSER=username
<BR>MYSQLPASSWORD=userpass 
<TD>
<IMG SRC="../img/nomysql.jpg">

<TR>
<TD>
<B>Если при обращении к веб интерфейсу вы наблюдаете такую картинку
(надпись "Fatal error: Call to undefined function: () in /usr/local/share/sams/tray.php on line XXX в нижнем фрейме"), то::</B>
<BR>В PHP выключена возможность получать переменные из URL.
<BR>В php.ini исправьте или добавьте строку:
<BR>register_globals = On 
<BR><em>ВНИМАНИЕ!!! Для версий SAMS с 2004 года это неактуально</em>
<TD>
<IMG SRC="../img/34_small.jpg">


</TABLE>

<H3 align="center">Общие вопросы по функционированию  SAMS</H3>

<P>
<B> При запуске samsdaemon вместо файла access.log появляется какой-то файл !access.log. 
Останавливаем samsdaemon, останавливаем сквид, запускаем сквид -  не запускается! 
После разборок выясняется, что мешает "/var/log/squid/|access.log". Удаляем - сквид работает.</B> 
<BR>Это FIFO файл, его создает при запуске утилита samsf. Почитайте об этом в документации к 
SAMS.
 
<P>
<B>При старте сервера все запускается прекрасно. Но стоит сделать переконфигурирование squid из 
web интерфейса, падает squid, так как куда-то девается файл паролей nsca.sams. Cтавим на свое 
место nsca.sams, запускаем ручками squid, тушим и запускаем ручками samsdaemon - все работает 
прекрасно (в том числе переконфигурация из веб-интерфейса). </B>
<BR>Файл ncsa.sams создается при помощи утилиты htpasswd. Видимо она у вас лежит где-нибуть в 
нестандартном месте. Например /usr/local/apache2/bin/htpasswd. Создайте симлинк или скопируйте htpasswd 
из /usr/local/apache2/bin/htpasswd в /usr/bin


<P>
<B> почему-то не конфигурится конфигурационный файл squid, вставляет только строку 
created by SAMS _sams_2004.10.12 12:56:11 и всё. 
Куда смотреть, где копать уже не знаю. Статистика работатет.</B>
<BR>Из файла squid.conf при настройке SQUID вами были удалены тэги начала разделов. 
При внесении изменений в squid.conf sams 
привязывается к тэгам, обозначающим начало разделов, например
<BR>#  TAG: acl
<BR>#  TAG: http_access
<BR>#  TAG: delay_pools
<BR>Наличие этих тэгов необходимо!!!

<P>
<BR><B>SAMS во много раз завышает трафик пользователей!!!. У меня стоит скрипт, который каждый день 
очищает файл access.log от записей с определенным ip</B> 
<BR>при ообработке файла с логами ваш скрипт вычищает записи из файла access.log, и его размер уменьшается. 
sams воспринитмает уменьшение размера файла access.log как признак произошедшей ротации логов, и начинает 
обрабатывать access.log сначала. Естественно, информация о трафике заносится в базу еще раз.


<P>
<B> при сохранение конфигурации вылезает ошибка:
<BR> Fatal error: Call to undefined function: gzopen() in ....../sams/src/backup.php on line XXX</B>
<BR>У вас старая версия php или php собран без поддержки возможности создания архивных файлов. 
Пересоберите php, установите более новую версию..

<P><B>У меня SQUID уже настроен и работает. Импортирует ли SAMS мои настройки из squid.conf?</B>
<BR>Нет, SAMS не импортирует настройки из squid.conf

<P><B>А если я пропишу правила прямо в squid для аськи их sams не тронет и
будут ли они работать ?</B>
<BR>SAMS при изменении squid.conf не удаляет никаких правил, он только добавляет необходимые правила для 
настройки доступа пользователей. По-этому возможен вариант, когда ваши правила будут противоречить правилам, 
созданных SAMS - например, ваши правила разрешают доступ к SQUID всем пользователям. В этом случае 
регулирование доступа через SAMS работать небудет. 

<P><B>Какие форматы лога squid может обрабатывать sams?</B>
<BR>SAMS обрабатывает формат access.log, Squid 1.1 родной формат:
<BR>Time Elapsed Host Status/HTTP Size Method URL Ident Hier_Status/Hier_Host
<BR>Пример:
<BR>1128157659.480 120133 192.168.0.77 TCP_MISS/200 672 CONNECT swap.karelia.ru:21 misha DIRECT/192.168.254.253 -
<BR>Чтобы привести формат лога к такому виду необходимо выставить в squid.conf:
<BR>emulate_httpd_log off

<P>
<B> wbinfo в консоли работает отлично, а в веб интерфейсе нет. Получить пользователей домена немогу.</B>
<BR>В консоли вы запускаете wbinfo от имени рута, со всеми его правами. В веб интерфейсе он вызывается с 
правами пользователя, о которого работает apache. Проверьте правильность пути к wbinfo в настройках SAMS, 
права на доступ к smb.conf (они могут быть, например rw-r----), посмотрите на логи winbind.  

<P>
<B> Я использую редиректрор XXXXXX. Будет ли работать SAMS (подсчет трафика, квоты и т.д.) не используя редиректор
samsredir?</B>
<BR>Без проблем. В настройках SAMS выставьте "Не использовать редиректор". SAMS настроит ограничения работы 
пользователей силами SQUID. 

<P>
<B> Если у пользователя осталось 10 Мб трафика, а он стал закачивать файл размером 100 Мб. Закачает ли пользователь файл?</B>
<BR>Закачает. SAMS отключает пользователя только по факту превышения трафика (есть запись в файле access.log). 
Существуют специальные патчи для SQUID, которые позволяют записывать в access.log информацию о скачивании файла по частям, например по 100 килобайт. 

<P>
<B> Если пользователь выбрал свой трафик до конца месяца, то приходится добавлять ему трафик. Но при этом 
допустимый объем на следующий остается "трафик пользователя" + добавленный трафик. Предлагаю внести понятие 
"временный трафик", чтобы можно было его добавлять юзерам, а на следующий месяц он не сохранялся.</B>
<BR>Это бесполезная трата времени. Зачем тогда вообще считать трафик юзеров, сделать им без ограничения и все? 
Юзеров может научить не качать что попало только отключение до конца месяца. Ну или штраф на сумму стоимости 
трафика, если он что-то скачал для  собственного развлечения :)
<BR>Другими словами, временного трафика в SAMS не будет.

<P>
<B>У меня утилита sams выпадает в segmentation fault и не считает трафик пользователей</B> 
<BR>Видимо во время записи в файл access.log у squid произощел какой-то сбой, и он записал туда неправильную 
информацию. В принципе, sams анализирует читаемые из access.log строки на соответствие некоторому шаблону и 
примерно 90% таких случаев будет обработано нормально, но иногда может не сработать.
<BR>Запустите в консоли 
<BR>sams -d  
<BR>будет выведена информация, в том числе:
<BR>end=XXXXX - смещение от начала файла access.log, с которого sams будет читать логи. 
<BR>откройте файл access.log в, например, редакторе файлового менеджера mc, и пройдите по смещению отначала. 
Это смещение должно указывать на начало строки. Если не так, подредактируйте файл, удалив лишние символы, 
чтобы начало следующей строки попало на это смещение

<P>
<B> SAMS сможет отловить, если произойдет ротация логов?</B>
<BR>Вы думаете я не слышал про это? Конечно я это учел. SAMS автоматически следит за размером лога, если 
размер файла меньше записи в счетчике, происходит сброс счетчика и файл считается с начала.


<P>
<B>Если SAMS встретит в access.log неизвестного пользователя (ip адрес), он посчитает его трафик?</B> 
<BR>Нет, SAMS рассчитан на то, что он будет считать и управлять ТОЛЬКО трафиком пользователей, 
зарегистрированных в SAMS. Если пользователя там нет, значит вы не хотите считать его трафик.

 
<P>
<B> Как прикрутить к apache 2.0 php4? Все делаю по инструкции ... ничего не получается. Браузер не понимает php.</B>
<BR>Я думаю, что объяснять как настраивать apache, mysql и другие программы не мое дело. Читайте документацию 
по необходимым программам.

<P>
<B> В плане безопасности мне боязно запускать на прокси сервере web сервер и mysql.</B>  
<BR>Как я предполагаю, прокси должен находиться в ДМЗ. Если не там, то никто не запрещает развернуть MySQL и Apache
где-нить в сети на другой машине (можно даже на разных), главное правильно настройте sams.conf на прокси 
и той, где расположен web-интерфейс.

<P>
<B> Я использую редиректор samsredir. В ACL squid разрешен доступ к прокси всем пользователям, 
даже тем, которые отключены</B>  
<BR>При использовании редиректора samsredir именно он запрещает доступ пользователей к прокси..


<H3 align="center">Другие вопросы по SAMS</H3>

<P>
<B> Планируется ли работа SAMS с PostgreSQL (M$SQL, ORACLE и т.п.) ,а то держать одновременно MySQL и PostgreSQL это роскошь:</B>
<BR>Вообще-то не планируется, так как это требует много времени. Вполне работает вариант, когда MySQL стоит на другой машине.

<P>
<B> Можно ли в SAMS добавить возможность...?</B>
<BR>Если у меня будет время и желание.
Если у вас есть нужда вы какой-либо дополнительной функции, то за некоторую сумму это можно сделать.

</BODY>
</HTML>
